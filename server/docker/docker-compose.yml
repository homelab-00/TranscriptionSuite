# TranscriptionSuite Docker Compose — Base Configuration
# ======================================================
# This is the base compose file with common service definition, volumes, and env.
# It is combined with platform and runtime overlays by the Electron dockerManager.
#
# Layered compose files:
#   docker-compose.yml              — This file (base: service, env, volumes)
#   docker-compose.linux-host.yml   — Linux: host networking
#   docker-compose.desktop-vm.yml   — macOS/Windows: bridge networking + port mapping
#   docker-compose.gpu.yml          — NVIDIA GPU reservation
#
# Manual usage (Linux + GPU, the default):
#   docker compose -f docker-compose.yml -f docker-compose.linux-host.yml -f docker-compose.gpu.yml up -d
#
# Manual usage (macOS/Windows, CPU mode):
#   docker compose -f docker-compose.yml -f docker-compose.desktop-vm.yml up -d
#
# For convenience, the Electron dashboard selects the correct stack automatically.
# For backward-compatible single-file Linux+GPU usage see: start-local.sh
#
# Build:
#   docker compose build
#
# Run (remote HTTPS with Tailscale):
#   1. Generate certs: tailscale cert your-machine.tailnet-name.ts.net
#   2. Start with env vars:
#      TLS_ENABLED=true \
#      TLS_CERT_PATH=~/.config/Tailscale/my-machine.crt \
#      TLS_KEY_PATH=~/.config/Tailscale/my-machine.key \
#      docker compose -f docker-compose.yml -f docker-compose.linux-host.yml -f docker-compose.gpu.yml up -d
#
# Optional environment variables:
#   HUGGINGFACE_TOKEN=xxx  # For downloading diarization models
#
# User Configuration & Logs:
#   The server looks for custom config and writes logs to a user config directory.
#   Mount your local config directory to enable custom settings and persistent logs:
#
#   Linux:
#     USER_CONFIG_DIR=~/.config/TranscriptionSuite docker compose up -d
#
#   Windows (PowerShell):
#     $env:USER_CONFIG_DIR="$env:USERPROFILE\Documents\TranscriptionSuite"
#     docker compose up -d
#
#   macOS:
#     USER_CONFIG_DIR=~/Library/Application\ Support/TranscriptionSuite docker compose up -d
#
#   To customize settings, copy config.yaml from the repo to your USER_CONFIG_DIR
#   and edit as needed. The server will use your custom config instead of defaults.

services:
  transcriptionsuite:
    build:
      context: ../..
      dockerfile: server/docker/Dockerfile
    image: ghcr.io/homelab-00/transcriptionsuite-server:${TAG:-latest}
    container_name: transcriptionsuite-container
    
    # Environment variables
    environment:
      - DATA_DIR=/data
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8000
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # HuggingFace token for downloading models (optional)
      - HF_TOKEN=${HUGGINGFACE_TOKEN:-}
      - HF_HOME=/models
      - BOOTSTRAP_RUNTIME_DIR=/runtime
      - BOOTSTRAP_CACHE_DIR=/runtime-cache
      - BOOTSTRAP_STATUS_FILE=/runtime/bootstrap-status.json
      - BOOTSTRAP_TIMEOUT_SECONDS=${BOOTSTRAP_TIMEOUT_SECONDS:-1800}
      - BOOTSTRAP_REQUIRE_HF_TOKEN=false
      - BOOTSTRAP_FINGERPRINT_SOURCE=${BOOTSTRAP_FINGERPRINT_SOURCE:-lockfile}
      - BOOTSTRAP_REBUILD_POLICY=${BOOTSTRAP_REBUILD_POLICY:-abi_only}
      - BOOTSTRAP_LOG_CHANGES=${BOOTSTRAP_LOG_CHANGES:-true}
      # LM Studio URL — overridden in platform overlay (host.docker.internal for VM platforms)
      - LM_STUDIO_URL=${LM_STUDIO_URL:-http://127.0.0.1:1234}
      # TLS settings for remote access (optional)
      - TLS_ENABLED=${TLS_ENABLED:-false}
      - TLS_CERT_FILE=/certs/cert.crt
      - TLS_KEY_FILE=/certs/cert.key
    
    # Volume mounts for persistent data
    volumes:
      - transcription-data:/data  # Database, audio files, tokens, logs
      - huggingface-models:/models  # Whisper and diarization models cache
      - runtime-deps:/runtime  # Runtime virtualenv and bootstrap marker state
      - uv-cache:/runtime-cache  # Persistent uv cache for delta dependency updates
      # User config directory (optional - for custom config.yaml and logs)
      # Set USER_CONFIG_DIR to mount your local config directory:
      #   Linux: USER_CONFIG_DIR=~/.config/TranscriptionSuite
      #   Windows: USER_CONFIG_DIR=$HOME/Documents/TranscriptionSuite
      #   macOS: USER_CONFIG_DIR=~/Library/Application Support/TranscriptionSuite
      - ${USER_CONFIG_DIR:-./.empty}:/user-config
      # TLS certificates (bind-mounted from host when TLS_CERT_PATH/TLS_KEY_PATH are set)
      - ${TLS_CERT_PATH:-./.empty}:/certs/cert.crt:ro
      - ${TLS_KEY_PATH:-./.empty}:/certs/cert.key:ro
    
    # Restart policy
    restart: unless-stopped
    
    # Health check - works with both HTTP and HTTPS modes
    healthcheck:
      test: ["CMD", "sh", "-c", "if [ \"$${TLS_ENABLED:-false}\" = \"true\" ]; then curl -f -k https://localhost:8443/health; else curl -f http://localhost:8000/health; fi"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 600s

volumes:
  transcription-data:
    name: transcriptionsuite-data
  huggingface-models:
    name: transcriptionsuite-models
  runtime-deps:
    name: transcriptionsuite-runtime
  uv-cache:
    name: transcriptionsuite-uv-cache
