# GitHub Actions Workflow for TranscriptionSuite Docker Image Publishing
#
# This workflow builds the TranscriptionSuite Docker image and pushes it to
# GitHub Container Registry (GHCR) at ghcr.io/homelab-00/transcriptionsuite-server
#
# Triggers:
#   1. Release tags (v*.*.*) - Automatically builds when you push tags like v1.0.0
#   2. Manual dispatch - Run from terminal with: gh workflow run docker-publish.yml
#
# Image Tagging Strategy:
#   - Release tag v1.0.0 â†’ Creates both :v1.0.0 and :latest tags
#   - Manual dispatch â†’ Creates custom tag (default: latest)
#
# Build Performance:
#   - First build: ~15-20 minutes (downloads all dependencies)
#   - Cached builds: ~5 minutes (70% faster with GitHub Actions cache)

name: Build and Push Docker Image to GHCR

# ============================================================================
# TRIGGERS: When should this workflow run?
# ============================================================================
on:
  # 1. Automatic: Triggered when you push a Git tag matching v*.*.* pattern
  #    Example: git tag v1.0.0 && git push origin v1.0.0
  push:
    tags:
      - 'v*.*.*'  # Matches v1.0.0, v2.1.3, etc.

  # 2. Manual: Triggered from terminal or GitHub UI
  #    Terminal: gh workflow run docker-publish.yml --field tag=dev
  #    UI: Go to Actions tab â†’ "Build and Push Docker Image" â†’ "Run workflow"
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag (leave empty for "latest")'
        required: false
        default: 'latest'
        type: string

# ============================================================================
# PERMISSIONS: What can this workflow access?
# ============================================================================
# Minimal permissions following security best practices
permissions:
  contents: read      # Read repository code
  packages: write     # Push to GitHub Container Registry
  id-token: write     # Optional: For provenance/SBOM generation

# ============================================================================
# JOBS: The actual work to be done
# ============================================================================
jobs:
  build-and-push:
    name: Build Docker Image and Push to GHCR
    runs-on: ubuntu-latest  # GitHub's hosted runner (Linux VM)

    steps:
      # ----------------------------------------------------------------------
      # STEP 1: Checkout Repository Code
      # ----------------------------------------------------------------------
      # This clones your repository into the GitHub Actions runner
      # Without this, the runner has no access to your Dockerfile or code
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------------------------
      # STEP 2: Extract Version from Git Tag
      # ----------------------------------------------------------------------
      # If triggered by a tag like v1.0.0, extract "1.0.0" for image tagging
      # If triggered manually, use the custom tag from workflow_dispatch input
      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Tag trigger: Extract version from git tag (e.g., v1.0.0 â†’ 1.0.0)
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=v${VERSION}" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Release build detected: v${VERSION}"
          else
            # Manual dispatch: Use custom tag from input (default: latest)
            TAG="${{ github.event.inputs.tag || 'latest' }}"
            echo "version=${TAG}" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Manual build with tag: ${TAG}"
          fi

      # ----------------------------------------------------------------------
      # STEP 3: Set up Docker Buildx
      # ----------------------------------------------------------------------
      # Buildx is Docker's extended build tool with advanced features:
      # - Multi-platform builds (amd64, arm64)
      # - Build caching (saves time on rebuilds)
      # - Optimized layer caching
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ----------------------------------------------------------------------
      # STEP 4: Login to GitHub Container Registry (GHCR)
      # ----------------------------------------------------------------------
      # Authenticates with GHCR using the auto-generated GITHUB_TOKEN
      # No manual PAT (Personal Access Token) setup needed!
      # The token is automatically provided by GitHub Actions
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}          # Your GitHub username
          password: ${{ secrets.GITHUB_TOKEN }}  # Auto-generated token

      # ----------------------------------------------------------------------
      # STEP 5: Extract Docker Metadata (Tags and Labels)
      # ----------------------------------------------------------------------
      # Automatically generates Docker tags and OCI labels based on:
      # - Git tags (v1.0.0 â†’ ghcr.io/.../server:v1.0.0)
      # - Latest tag (for releases only)
      # - Build metadata (commit SHA, build date)
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/homelab-00/transcriptionsuite-server
          tags: |
            # For release tags: create both versioned tag and latest
            type=semver,pattern=v{{version}},enable=${{ steps.version.outputs.is_release == 'true' }}
            type=raw,value=latest,enable=${{ steps.version.outputs.is_release == 'true' }}
            # For manual dispatch: use custom tag
            type=raw,value=${{ steps.version.outputs.version }},enable=${{ steps.version.outputs.is_release == 'false' }}
          labels: |
            org.opencontainers.image.title=TranscriptionSuite Server
            org.opencontainers.image.description=AI transcription server with Whisper and diarization
            org.opencontainers.image.vendor=homelab-00

      # ----------------------------------------------------------------------
      # STEP 6: Build and Push Docker Image
      # ----------------------------------------------------------------------
      # This is the main step that builds your Docker image and pushes to GHCR
      # Build caching dramatically reduces build time on subsequent runs
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          # Build context (root of repository, not docker/ subdirectory)
          context: .

          # Path to Dockerfile
          file: docker/Dockerfile

          # Push to registry (set to false for testing/PR builds)
          push: true

          # Image tags (generated by metadata step above)
          tags: ${{ steps.meta.outputs.tags }}

          # OCI labels (author, description, etc.)
          labels: ${{ steps.meta.outputs.labels }}

          # Platform(s) to build for
          # Currently: amd64 (Intel/AMD 64-bit)
          # Future: Add arm64 for Apple Silicon / ARM servers
          platforms: linux/amd64

          # Build caching configuration
          # - type=gha,mode=max: Use GitHub Actions cache (fastest)
          # - Caches all layers (not just final image)
          # - Reduces build time from ~20min to ~5min
          cache-from: type=gha
          cache-to: type=gha,mode=max

          # Build arguments (optional - can pass build-time variables)
          # build-args: |
          #   VERSION=${{ steps.version.outputs.version }}

      # ----------------------------------------------------------------------
      # STEP 7: Output Summary
      # ----------------------------------------------------------------------
      # Prints a summary of what was built and pushed
      # Visible in the GitHub Actions workflow summary page
      - name: Image publish summary
        run: |
          echo "## ðŸŽ‰ Docker Image Published Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** GitHub Container Registry (GHCR)" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`ghcr.io/homelab-00/transcriptionsuite-server\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/homelab-00/transcriptionsuite-server:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
